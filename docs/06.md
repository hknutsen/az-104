# Monitor and back up Azure resources

## Configure file and folder backups

- Azure Backup service
- Highlighted features:
  - Backup on-premises resources to the cloud
  - Backup Azure VMs
  - Backup Azure Files, Blobs, managed disks
  - Backup Azure Database for PostgreSQL server
  - Backups stored in Azure Recovery Services vault
  - Configure backup policies that define frequency, retention...
  - Unlimited and no cost inbound/outbound data transfer during restore operations
  - Encrypt backups with locally stored passphrase
  - Get app-consistent backups
    - No extra fixes required for the backups to work
  - Retain short- and long-term data
    - No limit on retention
    - Limit of 9,999 recovery points per instance
  - Storage replication options
    - LRS
    - ZRS
    - GRS
  - Soft delete
- Backup center
  - Unified management experience for Azure Backup
  - Govern, monitor, operate and analyze backups
- Recovery Services vault
  - Automatically manages Storage for you
  - You only need to specify replication
- Microsoft Azure Recovery Services (MARS) agent
  - Backs up on-prem resource or Azure VM to Azure Backup
  - Agent runs on the machine to be backed up.
- Configure on-prem backup:

  ![Azure Backup for on-prem server](../img/azure-backup-on-prem.png)

## Configure virtual machine backups

- Backup options for VMs:
  - Azure Backup
    - Takes snapshot of VM and stores data as recovery points in geo-redundant Azure Recovery Services vault
    - Restore entire VM or specific files
  - Azure Site Recovery
    - Replicates VMs to secondary region
    - Protects VMs from major disaster scenario where entire region experiences an outage
  - Azure managed disk - snapshot
    - Read-only full copy of a managed disk
    - Each snapshot is stored independent of the source disk and can be used to create new identical managed disks
    - Billed for actual size of snapshot
      - If 10/64 GB used, you're only billed for the 10 GB used, not the 64 GB available
  - Azure managed disks - image
    - Capture single image that contains all managed disks associated with a VM
    - Including both OS and data disks
- Back up your VMs:
  1. Create a Recovery Services vault
      - Specify region
      - Specify storage replication
  1. Define your backup policy options
      - Define when to take snapshots (frequency)
      - Define how long to store snapshots (retention)
  1. Back up your virtual machine
      - Install and configure MARS on VM
      - If VM was created from Azure gallery, MARS should already be installed
- Other options for VM backups:
  - System Center Data Protection Manager (DPM)
  - Microsoft Azure Backup Server (MABS)
  - Back up VMs to DPM or MABS storage, then back up the DPM or MABS storage to an Azure Recovery Services vault
  - To backup on-prem machines, DPM or MABS **instance** must run on-prem
  - To backup Azure VMs, DPM or MABS **instance** must be run on an Azure VM
  - DPM or MABS **protection agent** must be installed on each machine (on-prem or cloud) to be backed up
  - DPM and MAPS provider more granular scheduling options
- Soft-delete for Azure VM backups
  - Deleted backup data is retained for a given number of days (default: 14)
  - Prevents accidental loss of backup data

## Configure Azure Monitor

## Configure Azure alerts

- Configure Azure alerts to react and send notifications based on telemetry data
- Helps detect and address issues
- Prevent disruption and downtime
- Configure Azure Monitor to capture telemetry data
- Create alerts based on captured telemetry data
- An alert consists of alert rules that combine the settings and conditions you want to monitor, including:
  - Resources to monitor
  - Signals or telemetry to gather from the resources
  - Conditions to match
- If an alert rule monitors multiple resources, it triggers separately for each resource
- When an alert triggers, it sends a notification based on a configured action group
- Action group defines receivers, including:
  - Azure roles
  - Email
  - SMS
  - Webhook (Slack, Teams...)

  ![Azure alerts](../img/azure-alerts.png)

- Common alert types:
  - Metric alerts: evaluate resource metrics data at regular intervals
  - Log alerts: evaluate resource logs at a predefined frequency
  - Activity log alerts: trigger when a new activity log event occurs (e.g. when a resource is deleted)
  - Smart detection alerts: trigger on potential performance issues and failure anomalies in your web app using Application Insights
- Alert states:
  - When the conditions of an alert rule are met, an alert triggers and invokes specified action group
    - Default alert state is `New`
    - This state is set automatically by Azure
    - This is the only state that is set automatically
  - When the issue that caused the alert is in review, you can change state to `Acknowledged`
  - Once issue has been resolved (or ignored), you can change state to `Closed`
  - Possible to "repoen" alert by changing state back to `New` or `Acknowledged`
- Azure Monitor conditions:
  - When an alert triggers, the Azure Monitor condition for that alert is `Fired`
  - When the alert is closed, the Azure Monitor condition is `Resolved`
- Stateless vs stateful alerts
  - Stateless alerts trigger each time your alert rule condition matches your data, even if same alert already exists
    - Activity logs are always stateless
  - Stateful alerts trigger when your alert rule condition matches your data, and the alert does not already exist
- Create alert rule:
  - Target resource
  - Alert signal
    - Metric
    - Log
    - Activity log
    - Application Insights
  - Rule criteria
    - E.g. `CPU percentage greater than 70%`
  - Issue severity
    - 0-4, where 4 is highest severity
  - Name
  - Description
- Action groups
  - Defines receivers that should be notified of alerts:
    - Email
    - SMS
    - Azure role
  - Can also define actions:
    - Trigger Azure Function
    - Trigger Azure Automation runbook
    - Trigger webhook
  - A single action group can be reused across alerts

## Configure Log Analytics

## Configure Network Watcher

## Improve incident response with alerting on Azure

## Analyze your Azure nfrastructure by using Azure Monitor logs

## Monitor performance of virtual machines by using Azure Monitor VM Insights
